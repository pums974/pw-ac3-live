name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          libclang-dev \
          libpipewire-0.3-dev \
          libspa-0.2-dev \
          ffmpeg

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Rust Build
      uses: Swatinem/rust-cache@v2

    - name: Check Formatting
      run: cargo fmt -- --check

    - name: Run Clippy
      run: cargo clippy -- -D warnings

    - name: Build
      run: cargo build --verbose

    - name: Run Tests
      run: cargo test --verbose

  integration:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          libclang-dev \
          libpipewire-0.3-dev \
          libspa-0.2-dev \
          ffmpeg \
          pipewire \
          pipewire-pulse \
          pipewire-bin \
          wireplumber \
          pipewire-audio-client-libraries \
          pulseaudio-utils \
          dbus-x11 \
          python3

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust Build
      uses: Swatinem/rust-cache@v2

    - name: Run Integration Test
      run: |
        export XDG_RUNTIME_DIR="/tmp/xdg-runtime-ci"
        mkdir -p "$XDG_RUNTIME_DIR"
        chmod 0700 "$XDG_RUNTIME_DIR"

        # Run integration tests that do not require a live PipeWire session.
        for test_script in tests/scripts/test_ci_*.sh; do
          test_name="$(basename "$test_script")"
          case "$test_name" in
            test_ci_help.sh|test_ci_alsa_args.sh)
              echo "═══ Running $test_name (no PipeWire session required) ═══"
              bash "$test_script"
              echo ""
              ;;
          esac
        done

        # Start PipeWire stack inside a private D-Bus session
        dbus-run-session bash -c '
          set -euo pipefail

          # Start PipeWire daemon
          pipewire &
          PW_PID=$!
          sleep 1

          # Start WirePlumber session manager
          wireplumber &
          WP_PID=$!
          sleep 1

          # Start PipeWire-Pulse compatibility layer (provides pactl)
          pipewire-pulse &
          PP_PID=$!
          sleep 1

          echo "PipeWire stack started (pw=$PW_PID wp=$WP_PID pp=$PP_PID)"
          pw-cli info 0 || { echo "PipeWire not responding"; exit 1; }

          # Run integration tests that require an active PipeWire session.
          for test_script in tests/scripts/test_ci_*.sh; do
            test_name="$(basename "$test_script")"
            case "$test_name" in
              test_ci_help.sh|test_ci_alsa_args.sh)
                continue
                ;;
            esac

            echo "═══ Running $test_name ═══"
            bash "$test_script"
            echo ""
          done

          # Run longer end-to-end integration suites.
          for test_script in tests/scripts/test_local_pipeline.sh tests/scripts/test_pipewire_pipeline.sh; do
            if [ -f "$test_script" ]; then
              test_name="$(basename "$test_script")"
              echo "═══ Running $test_name ═══"
              bash "$test_script"
              echo ""
            fi
          done

          # Cleanup
          kill $PP_PID $WP_PID $PW_PID 2>/dev/null || true
        '
